<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass Metaballs with Environment Map</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: system-ui, sans-serif;
        }

        #container {
            width: 100vw;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
        }

        #info .subtitle {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <div id="info">
        <div>Move your mouse to look around</div>
        <div class="subtitle">Glass metaballs morphing together</div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { MarchingCubes } from 'three/addons/objects/MarchingCubes.js';

        const container = document.getElementById('container');

        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(0, 0, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1;
        container.appendChild(renderer.domElement);

        // Load real cubemap environment
        const cubeTextureLoader = new THREE.CubeTextureLoader();
        cubeTextureLoader.setPath('https://threejs.org/examples/textures/cube/Park3Med/');

        const envMap = cubeTextureLoader.load([
            'px.jpg', 'nx.jpg',
            'py.jpg', 'ny.jpg',
            'pz.jpg', 'nz.jpg'
        ]);

        scene.background = envMap;

        // Create marching cubes for metaballs
        const resolution = 60; // Higher = smoother but slower (try 30-80)
        const glassMaterial = new THREE.MeshPhysicalMaterial({
            metalness: 0,
            roughness: 0,
            transmission: 1,
            thickness: 0.5,
            envMap: envMap,
            envMapIntensity: 1.5,
            ior: 1.5,
            clearcoat: 1,
            clearcoatRoughness: 0,
            side: THREE.DoubleSide
        });

        const effect = new MarchingCubes(resolution, glassMaterial, true, true, 100000);

        effect.position.set(0, 0, 0);
        effect.scale.set(3, 3, 3);
        effect.enableUvs = false;
        effect.enableColors = false;
        effect.isolation = 80;

        scene.add(effect);

        console.log('Marching cubes resolution:', resolution);

        // Lighting
        const light1 = new THREE.DirectionalLight(0xffffff, 1);
        light1.position.set(5, 5, 5);
        scene.add(light1);

        const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
        light2.position.set(-5, -5, 5);
        scene.add(light2);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        // Mouse interaction
        let mouseX = 0;
        let mouseY = 0;

        window.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        });

        // Animation
        let time = 0;
        const numBlobs = 4;

        function updateMetaballs() {
            effect.reset();

            const subtract = 8;
            const strength = 2.5;

            for (let i = 0; i < numBlobs; i++) {
                const angle = (i / numBlobs) * Math.PI * 2;
                const radius = 0.3;

                const ballx = 0.5 + Math.cos(angle + time * 0.5) * radius;
                const bally = 0.5 + Math.sin(time * 0.7 + i * 0.5) * 0.15;
                const ballz = 0.5 + Math.sin(angle + time * 0.5) * radius;

                effect.addBall(ballx, bally, ballz, strength, subtract);
            }

            // This is critical - we need to call update() to generate the mesh
            effect.update();

            if (time < 1) {
                console.log('Vertex count after update:', effect.count);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.015;

            // Smooth camera movement based on mouse
            const targetX = mouseX * 3;
            const targetY = mouseY * 3;
            camera.position.x += (targetX - camera.position.x) * 0.05;
            camera.position.y += (targetY - camera.position.y) * 0.05;
            camera.lookAt(0, 0, 0);

            // Update metaballs
            updateMetaballs();

            renderer.render(scene, camera);
        }

        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>